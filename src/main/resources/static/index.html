<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Galaxy</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Puter.js for free Grok AI access -->
    <script src="https://js.puter.com/v2/"></script>
    <!--    <script>-->
    <!--        /* ================= CACHE HELPERS ================= */-->
    <!--        function setCache(key, data, ttlMs) {-->
    <!--            const record = {-->
    <!--                data,-->
    <!--                expiry: Date.now() + ttlMs-->
    <!--            };-->
    <!--            localStorage.setItem(key, JSON.stringify(record));-->
    <!--        }-->

    <!--        function getCache(key) {-->
    <!--            const record = localStorage.getItem(key);-->
    <!--            if (!record) return null;-->

    <!--            const parsed = JSON.parse(record);-->
    <!--            if (Date.now() > parsed.expiry) {-->
    <!--                localStorage.removeItem(key);-->
    <!--                return null;-->
    <!--            }-->
    <!--            return parsed.data;-->
    <!--        }-->
    <!--    </script>-->

    <style>
        * {
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }

        body {
            background: #f5f7fa;
            color: #1e293b;
            min-height: 100vh;
        }

        /* HEADER */
        header {
            background: #fff;
            padding: 16px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .header-title {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
        }

        .header-nav {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .header-nav-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: 8px;
            text-decoration: none;
            color: #64748b;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            background: transparent;
        }

        .header-nav-item:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        .header-nav-item.active {
            background: #2563eb;
            color: #fff;
        }

        .header-nav-item .nav-icon {
            font-size: 14px;
        }

        .header-nav-item .nav-text {
            font-weight: 600;
        }

        .header-stats {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .stat-item {
            text-align: right;
        }

        .stat-label {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
        }

        .stat-value.positive { color: #10b981; }
        .stat-value.negative { color: #ef4444; }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        /* LAYOUT */
        .main-layout {
            display: flex;
            min-height: calc(100vh - 70px);
        }

        /* SIDEBAR */
        .sidebar {
            width: 220px;
            background: #fff;
            padding: 24px 0;
            box-shadow: 1px 0 3px rgba(0,0,0,0.05);
        }

        .nav-item {
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            color: #64748b;
            font-weight: 500;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        .nav-item.active {
            background: #2563eb;
            color: #fff;
            border-right: 3px solid #1d4ed8;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            padding: 30px;
            background: #f5f7fa;
            overflow-y: auto;
        }

        /* BUTTONS */
        button {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #2563eb;
            color: #fff;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: #fff;
            color: #1e293b;
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #f8fafc;
        }

        .btn-danger {
            background: #ef4444;
            color: #fff;
        }

        /* GRID LAYOUT */
        .dashboard-grid {
            display: grid;
            gap: 24px;
            margin-bottom: 30px;
        }

        .grid-2 {
            grid-template-columns: 1fr 1fr;
        }

        .grid-4 {
            grid-template-columns: repeat(4, 1fr);
        }

        /* CARD */
        .card {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
        }

        /* CHARTS */
        .chart-container {
            position: relative;
            height: 300px;
        }

        .chart-container canvas {
            max-height: 100%;
        }

        .chart-legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        /* TABLE */
        .holdings-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .holdings-table th {
            text-align: left;
            padding: 12px 16px;
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .holdings-table td {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
        }

        .holdings-table tr:hover {
            background: #f8fafc;
        }

        .profit-positive {
            color: #10b981;
            font-weight: 600;
        }

        .profit-negative {
            color: #ef4444;
            font-weight: 600;
        }

        /* VALUE CARDS */
        .value-card {
            text-align: center;
        }

        .value-card-label {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 8px;
        }

        .value-card-amount {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
        }

        /* MARKET DATA */
        .market-item {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .market-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .market-ticker {
            font-weight: 600;
            color: #1e293b;
        }

        .market-change {
            font-size: 14px;
            font-weight: 600;
        }

        .market-details {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
        }

        /* AI CHAT WIDGET */
        .ai-chat-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(37, 99, 235, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            z-index: 999;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .ai-chat-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(37, 99, 235, 0.5);
        }

        .ai-chat-container {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 400px;
            max-width: calc(100vw - 40px);
            height: 550px;
            max-height: calc(100vh - 150px);
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 998;
            animation: chatSlideUp 0.3s ease-out;
        }

        .ai-chat-container.show {
            display: flex;
        }

        @keyframes chatSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-chat-header {
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            color: white;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ai-chat-header h3 {
            margin: 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-chat-header .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-chat-header .close-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .ai-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #f8fafc;
        }

        .ai-message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.5;
            animation: messageIn 0.3s ease-out;
        }

        @keyframes messageIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-message.user {
            background: #2563eb;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .ai-message.assistant {
            background: white;
            color: #1e293b;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .ai-message.assistant pre {
            background: #f1f5f9;
            padding: 8px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
        }

        .ai-message.typing {
            background: white;
            color: #64748b;
            display: flex;
            gap: 4px;
            padding: 16px 20px;
        }

        .ai-message.typing span {
            width: 8px;
            height: 8px;
            background: #94a3b8;
            border-radius: 50%;
            animation: typing 1.4s infinite both;
        }

        .ai-message.typing span:nth-child(2) { animation-delay: 0.2s; }
        .ai-message.typing span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        .ai-chat-input {
            padding: 16px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
        }

        .ai-chat-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 25px;
            outline: none;
            font-size: 14px;
        }

        .ai-chat-input input:focus {
            border-color: #2563eb;
        }

        .ai-chat-input button {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #2563eb;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: background 0.2s;
        }

        .ai-chat-input button:hover {
            background: #1d4ed8;
        }

        .ai-chat-input button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        .ai-quick-actions {
            padding: 12px 16px;
            background: white;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            border-top: 1px solid #e2e8f0;
        }

        .ai-quick-btn {
            padding: 6px 12px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            font-size: 12px;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ai-quick-btn:hover {
            background: #e2e8f0;
            color: #1e293b;
        }

        @media (max-width: 480px) {
            .ai-chat-container {
                bottom: 0;
                right: 0;
                width: 100%;
                max-width: 100%;
                height: 100%;
                max-height: 100%;
                border-radius: 0;
            }
            .ai-chat-toggle {
                bottom: 20px;
                right: 20px;
            }
        }

        /* MODAL */
        .modal-bg {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-bg.show {
            display: flex;
        }

        .modal {
            background: #fff;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 0 60px rgba(0,0,0,0.1);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal h2 {
            margin-bottom: 24px;
            color: #1e293b;
        }

        /* INPUTS */
        .input-group {
            margin-bottom: 16px;
        }

        .input-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 6px;
        }

        input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            outline: none;
            font-size: 14px;
        }

        input:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }

        input[readonly] {
            background: #f8fafc;
            color: #64748b;
        }

        /* SEARCH */
        .search-box {
            position: relative;
        }

        .search-results {
            position: absolute;
            width: 100%;
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        .search-results div {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #e2e8f0;
        }

        .search-results div:hover {
            background: #f8fafc;
        }

        .search-results div:last-child {
            border-bottom: none;
        }

        /* TOAST */
        #toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #1e293b;
            color: #fff;
            padding: 16px 24px;
            border-radius: 8px;
            display: none;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            z-index: 1001;
        }

        /* SCROLLSPY NAVIGATION - Hidden, using header nav instead */
        .scrollspy-nav {
            display: none;
        }

        .scrollspy-item {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 10px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            text-decoration: none;
            color: #64748b;
        }

        .scrollspy-item:hover {
            background: #fff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            transform: translateX(-5px);
        }

        .scrollspy-item.active {
            background: #2563eb;
            color: #fff;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
        }

        .scrollspy-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .scrollspy-label {
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            max-width: 0;
            overflow: hidden;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .scrollspy-item:hover .scrollspy-label,
        .scrollspy-item.active .scrollspy-label {
            max-width: 150px;
            opacity: 1;
            margin-right: 4px;
        }

        .scroll-section {
            scroll-margin-top: 100px;
        }

        @media (max-width: 768px) {
            .scrollspy-nav {
                top: auto;
                bottom: 100px;
                right: 10px;
                transform: none;
            }
            .scrollspy-item {
                padding: 8px;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                justify-content: center;
            }
            .scrollspy-label {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .scrollspy-nav {
                bottom: 90px;
                right: 8px;
            }
            .scrollspy-item {
                width: 36px;
                height: 36px;
                padding: 6px;
            }
            .scrollspy-icon {
                font-size: 14px;
            }
        }

        /* IPO SECTION */
        .ipo-header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .ipo-tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .ipo-tab {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            background: #fff;
            color: #64748b;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
        }

        .ipo-tab:hover {
            background: #f8fafc;
            border-color: #2563eb;
        }

        .ipo-tab.active {
            background: #2563eb;
            color: #fff;
            border-color: #2563eb;
        }

        .ipo-refresh-btn {
            padding: 8px 16px;
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            color: #64748b;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .ipo-refresh-btn:hover {
            background: #f8fafc;
            border-color: #2563eb;
            color: #2563eb;
        }

        .cache-indicator {
            font-size: 12px;
            color: #64748b;
            margin-top: 8px;
        }

        .ipo-container {
            display: grid;
            gap: 16px;
        }

        .ipo-card {
            background: #f8fafc;
            border-radius: 8px;
            padding: 16px;
            border-left: 4px solid #2563eb;
        }

        .ipo-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .ipo-logo {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
        }

        .ipo-name {
            flex: 1;
        }

        .ipo-name h4 {
            margin: 0;
            font-size: 16px;
            color: #1e293b;
        }

        .ipo-name span {
            font-size: 12px;
            color: #64748b;
        }

        .ipo-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }

        .ipo-detail {
            background: #fff;
            padding: 8px;
            border-radius: 6px;
        }

        .ipo-detail-label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
        }

        .ipo-detail-value {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            margin-top: 4px;
        }

        .ipo-about {
            font-size: 13px;
            line-height: 1.6;
            color: #64748b;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
        }

        /* RESPONSIVE DESIGN */

        /* Large Screens (1200px and above) */
        @media (max-width: 1200px) {
            header {
                padding: 16px 32px;
            }
            .main-content {
                padding: 24px;
            }
            .header-nav {
                gap: 4px;
            }
            .header-nav-item {
                padding: 6px 10px;
                font-size: 12px;
            }
        }

        /* Tablets and Medium Screens (1024px to 1199px) */
        @media (max-width: 1024px) {
            header {
                flex-wrap: wrap;
                gap: 12px;
                padding: 16px 24px;
            }

            .header-left {
                width: 100%;
                justify-content: space-between;
            }

            .header-title {
                font-size: 22px;
            }

            .header-nav {
                gap: 4px;
            }

            .header-nav-item {
                padding: 6px 10px;
                font-size: 11px;
            }

            .header-nav-item .nav-text {
                display: none;
            }

            .header-nav-item .nav-icon {
                font-size: 16px;
            }

            .header-stats {
                flex: 0 1 auto;
                gap: 20px;
            }

            .stat-value {
                font-size: 18px;
            }

            .stat-label {
                font-size: 12px;
            }

            .sidebar {
                width: 200px;
                padding: 16px 0;
            }

            .nav-item {
                padding: 10px 16px;
                font-size: 14px;
            }

            .main-content {
                padding: 20px;
            }

            .card {
                padding: 20px;
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }

            .grid-4 {
                grid-template-columns: repeat(2, 1fr);
            }

            .dashboard-grid {
                gap: 20px;
            }

            .chart-container {
                height: 280px;
            }

            .holdings-table th,
            .holdings-table td {
                padding: 12px;
                font-size: 13px;
            }
        }

        /* Tablets (768px to 1023px) */
        @media (max-width: 1023px) {
            header {
                padding: 12px 16px;
                flex-direction: column;
                align-items: flex-start;
            }

            .header-title {
                font-size: 20px;
                width: 100%;
                margin-bottom: 8px;
            }

            .header-stats {
                width: 100%;
                flex-direction: row;
                justify-content: space-between;
                gap: 10px;
            }

            .stat-item {
                text-align: left;
                flex: 1;
                min-width: 150px;
            }

            .stat-label {
                font-size: 11px;
                margin-bottom: 2px;
            }

            .stat-value {
                font-size: 16px;
            }

            .header-actions {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
                gap: 8px;
            }

            .header-actions button {
                flex: 1;
                min-width: 120px;
                padding: 8px 12px;
                font-size: 12px;
            }

            .main-layout {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                padding: 0;
                box-shadow: none;
                border-bottom: 1px solid #e2e8f0;
                display: flex;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .nav-item {
                padding: 12px 14px;
                white-space: nowrap;
                flex-shrink: 0;
                font-size: 13px;
                min-width: fit-content;
            }

            .nav-item.active {
                border-right: none;
                border-bottom: 3px solid #2563eb;
                padding-bottom: 10px;
            }

            .main-content {
                padding: 16px;
            }

            .header-left {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .header-nav {
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 4px;
            }

            .header-nav-item {
                padding: 6px 10px;
            }

            .header-nav-item .nav-text {
                display: inline;
                font-size: 11px;
            }

            .card {
                padding: 16px;
                border-radius: 10px;
            }

            .card-title {
                font-size: 16px;
            }

            .dashboard-grid {
                gap: 16px;
                margin-bottom: 20px;
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }

            .grid-4 {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 250px;
            }

            .holdings-table {
                font-size: 12px;
            }

            .holdings-table th,
            .holdings-table td {
                padding: 10px;
            }

            button {
                padding: 8px 16px;
                font-size: 13px;
            }

            .btn-primary,
            .btn-secondary,
            .btn-danger {
                min-width: 100px;
            }

            .modal {
                margin: 15% auto;
                padding: 20px;
                max-width: 85%;
            }

            .modal h2 {
                font-size: 20px;
            }

            .input-label {
                font-size: 13px;
            }

            input {
                padding: 10px;
                font-size: 13px;
            }

            .ipo-details {
                grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
                gap: 10px;
            }

            .ipo-detail {
                padding: 8px;
            }

            .ipo-detail-label {
                font-size: 10px;
            }

            .ipo-detail-value {
                font-size: 13px;
            }

            .market-item {
                padding: 10px 0;
            }
        }

        /* Small Tablets and Large Phones (481px to 767px) */
        @media (max-width: 767px) {
            header {
                padding: 10px 12px;
                flex-direction: column;
                align-items: stretch;
            }

            .header-title {
                font-size: 18px;
                margin-bottom: 10px;
            }

            .header-stats {
                width: 100%;
                flex-direction: column;
                gap: 8px;
            }

            .stat-item {
                text-align: left;
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 0;
                border-bottom: 1px solid #e2e8f0;
            }

            .stat-item:last-child {
                border-bottom: none;
            }

            .stat-label {
                font-size: 11px;
                margin-bottom: 0;
                flex: 1;
            }

            .stat-value {
                font-size: 14px;
                text-align: right;
            }

            .header-actions {
                width: 100%;
                flex-direction: column;
                gap: 6px;
                margin-top: 8px;
            }

            .header-actions button {
                width: 100%;
                padding: 10px 8px;
                font-size: 12px;
            }

            .sidebar {
                width: 100%;
                padding: 8px 0;
                border-bottom: 1px solid #e2e8f0;
                display: flex;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .nav-item {
                padding: 10px 12px;
                white-space: nowrap;
                flex-shrink: 0;
                font-size: 12px;
                min-width: fit-content;
                border-bottom: 3px solid transparent;
            }

            .nav-item.active {
                border-right: none;
                border-bottom: 3px solid #2563eb;
                background: transparent;
            }

            .nav-icon {
                width: 18px;
                height: 18px;
                font-size: 14px;
            }

            .main-content {
                padding: 12px;
                overflow-x: hidden;
            }

            .card {
                padding: 14px;
                border-radius: 8px;
                margin-bottom: 12px;
            }

            .card-header {
                margin-bottom: 14px;
            }

            .card-title {
                font-size: 15px;
            }

            .dashboard-grid {
                gap: 12px;
                margin-bottom: 12px;
            }

            .grid-2,
            .grid-4 {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 220px;
                margin-bottom: 12px;
            }

            .holdings-table {
                font-size: 11px;
                margin-top: 10px;
            }

            .holdings-table th,
            .holdings-table td {
                padding: 8px 6px;
            }

            .holdings-table th {
                font-size: 10px;
                padding: 8px 4px;
            }

            button {
                padding: 8px 12px;
                font-size: 12px;
                border-radius: 6px;
            }

            .btn-primary,
            .btn-secondary,
            .btn-danger {
                min-width: 80px;
                padding: 8px 10px;
            }

            .modal {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                margin: 0;
                padding: 18px;
                max-width: 90%;
                max-height: 90vh;
                overflow-y: auto;
                border-radius: 12px;
            }

            .modal h2 {
                font-size: 18px;
                margin-bottom: 16px;
            }

            .input-group {
                margin-bottom: 14px;
            }

            .input-label {
                font-size: 12px;
                margin-bottom: 6px;
            }

            input {
                padding: 10px;
                font-size: 14px;
                border-radius: 6px;
            }

            .modal-bg {
                display: none;
            }

            .modal-bg.show {
                display: block;
            }

            .value-card-amount {
                font-size: 20px;
            }

            .search-results {
                max-height: 150px;
                border-radius: 6px;
            }

            .search-results div {
                padding: 10px;
                font-size: 12px;
            }

            .market-item {
                padding: 10px 0;
                margin-bottom: 8px;
            }

            .market-ticker {
                font-size: 13px;
            }

            .ipo-card {
                padding: 12px;
            }

            .ipo-header {
                gap: 10px;
            }

            .ipo-logo {
                width: 40px;
                height: 40px;
            }

            .ipo-name h4 {
                font-size: 14px;
            }

            .ipo-details {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 8px;
            }

            .ipo-detail {
                padding: 6px;
            }

            .ipo-detail-label {
                font-size: 9px;
            }

            .ipo-detail-value {
                font-size: 12px;
            }

            .ipo-about {
                font-size: 12px;
            }

            .ipo-tabs {
                flex-wrap: wrap;
                gap: 6px;
            }

            .ipo-tab {
                padding: 6px 12px;
                font-size: 12px;
            }
        }

        /* Mobile Phones (max 480px) */
        @media (max-width: 480px) {
            * {
                font-size: 14px;
            }

            header {
                padding: 8px 10px;
                flex-direction: column;
                gap: 6px;
            }

            .header-title {
                font-size: 16px;
                margin-bottom: 4px;
            }

            .header-stats {
                width: 100%;
                flex-direction: column;
                gap: 6px;
            }

            .stat-item {
                display: flex;
                justify-content: space-between;
                padding: 6px 0;
                border-bottom: 1px solid #e2e8f0;
            }

            .stat-label {
                font-size: 10px;
                margin-bottom: 0;
            }

            .stat-value {
                font-size: 12px;
                text-align: right;
            }

            .header-actions {
                width: 100%;
                flex-direction: column;
                gap: 4px;
                margin-top: 6px;
            }

            .header-actions button {
                width: 100%;
                padding: 8px 6px;
                font-size: 11px;
            }

            .sidebar {
                padding: 6px 0;
                gap: 2px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }

            .nav-item {
                padding: 8px 10px;
                font-size: 11px;
                min-width: fit-content;
            }

            .nav-icon {
                width: 16px;
                height: 16px;
                font-size: 12px;
            }

            .main-content {
                padding: 8px;
            }

            .card {
                padding: 10px;
                border-radius: 8px;
                margin-bottom: 8px;
            }

            .card-header {
                margin-bottom: 10px;
                gap: 6px;
            }

            .card-title {
                font-size: 13px;
            }

            .dashboard-grid {
                gap: 8px;
                margin-bottom: 8px;
            }

            .grid-2,
            .grid-4 {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .chart-container {
                height: 200px;
                margin-bottom: 8px;
            }

            .chart-legend {
                gap: 8px;
                margin-top: 8px;
                font-size: 11px;
            }

            .holdings-table {
                font-size: 10px;
                margin-top: 8px;
                width: 100%;
                overflow-x: auto;
                display: block;
            }

            .holdings-table thead {
                display: none;
            }

            .holdings-table tr {
                display: block;
                margin-bottom: 8px;
                border: 1px solid #e2e8f0;
                border-radius: 6px;
                padding: 8px;
                background: #f8fafc;
            }

            .holdings-table td {
                display: block;
                padding: 4px 0;
                border: none;
                text-align: left;
            }

            .holdings-table td:before {
                content: attr(data-label);
                font-weight: 600;
                display: block;
                font-size: 10px;
                color: #64748b;
                margin-bottom: 2px;
            }

            button {
                padding: 6px 8px;
                font-size: 11px;
                border-radius: 4px;
            }

            .btn-primary,
            .btn-secondary,
            .btn-danger {
                padding: 6px 8px;
                font-size: 10px;
            }

            .modal {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                margin: 0;
                padding: 12px;
                max-width: 95%;
                max-height: 85vh;
                overflow-y: auto;
                border-radius: 10px;
            }

            .modal h2 {
                font-size: 16px;
                margin-bottom: 12px;
            }

            .input-group {
                margin-bottom: 10px;
            }

            .input-label {
                font-size: 11px;
                margin-bottom: 4px;
            }

            input {
                padding: 8px;
                font-size: 13px;
                border-radius: 4px;
            }

            input:focus {
                box-shadow: 0 0 0 2px rgba(37,99,235,0.1);
            }

            .value-card {
                text-align: center;
            }

            .value-card-label {
                font-size: 10px;
                margin-bottom: 4px;
            }

            .value-card-amount {
                font-size: 16px;
            }

            .search-results {
                max-height: 120px;
                border-radius: 4px;
            }

            .search-results div {
                padding: 8px;
                font-size: 11px;
            }

            #toast {
                bottom: 10px;
                right: 10px;
                padding: 10px 12px;
                font-size: 11px;
                border-radius: 6px;
            }

            .market-item {
                padding: 8px 0;
                margin-bottom: 6px;
            }

            .market-ticker {
                font-size: 12px;
                margin-bottom: 4px;
            }

            .ipo-card {
                padding: 10px;
                border-left: 3px solid #2563eb;
            }

            .ipo-header {
                gap: 8px;
            }

            .ipo-logo {
                width: 35px;
                height: 35px;
            }

            .ipo-name h4 {
                font-size: 12px;
            }

            .ipo-name span {
                font-size: 10px;
            }

            .ipo-details {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
                gap: 6px;
            }

            .ipo-detail {
                padding: 4px;
            }

            .ipo-detail-label {
                font-size: 8px;
            }

            .ipo-detail-value {
                font-size: 11px;
            }

            .ipo-about {
                font-size: 11px;
                margin-top: 8px;
                padding-top: 8px;
            }

            .ipo-header-section {
                flex-direction: column;
            }

            .ipo-tabs {
                width: 100%;
                flex-wrap: nowrap;
                overflow-x: auto;
                gap: 4px;
            }

            .ipo-tab {
                padding: 6px 10px;
                font-size: 11px;
                flex-shrink: 0;
            }

            .ipo-refresh-btn {
                width: 100%;
                margin-top: 6px;
            }
        }
    </style>
</head>

<body>

<!-- HEADER -->
<header>
    <div class="header-left">
        <div class="header-title">GALAXY</div>
        <nav class="header-nav" id="headerNav">
            <a href="#holdingsSection" class="header-nav-item active" data-section="holdingsSection">
                <span class="nav-icon">ðŸ“Š</span>
                <span class="nav-text">Holdings</span>
            </a>
            <a href="#ipoSection" class="header-nav-item" data-section="ipoSection">
                <span class="nav-icon">ðŸš€</span>
                <span class="nav-text">IPOs</span>
            </a>
            <a href="#marketSection" class="header-nav-item" data-section="marketSection">
                <span class="nav-icon">ðŸ“ˆ</span>
                <span class="nav-text">Market</span>
            </a>
            <a href="#newsSection" class="header-nav-item" data-section="newsSection">
                <span class="nav-icon">ðŸ“°</span>
                <span class="nav-text">News</span>
            </a>
        </nav>
    </div>
    <div class="header-stats">
        <div class="stat-item">
            <div class="stat-label">Total Portfolio Value:</div>
            <div class="stat-value positive" id="totalValue">$0.00</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">Total Return:</div>
            <div class="stat-value positive" id="totalReturn">+0.0%</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">Unrealized P/L:</div>
            <div class="stat-value" id="unrealizedPL">$0.00</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">Realized P/L:</div>
            <div class="stat-value" id="realizedPL">$0.00</div>
        </div>
        <div class="header-actions">
            <button class="btn-primary" onclick="openAddStockModal()">+ Add Asset</button>
            <button class="btn-secondary" onclick="removeAllAssets()">Remove Asset</button>
        </div>
    </div>
</header>

<!-- MAIN LAYOUT -->
<div class="main-layout">
    <!-- MAIN CONTENT -->
    <main class="main-content" style="margin-left: 0; width: 100%;">
        <!-- DASHBOARD SECTION -->
        <div id="dashboardSection">
            <!-- TOP ROW: ASSET ALLOCATION & PERFORMANCE CHART -->
            <div class="dashboard-grid grid-2">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Asset Allocation</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="allocationChart"></canvas>
                    </div>
                    <div class="chart-legend" id="allocationLegend"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Portfolio Performance</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- HOLDINGS TABLE -->
            <div class="card scroll-section" id="holdingsSection">
                <div class="card-header">
                    <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                        <div>
                            <h3 class="card-title" style="margin-bottom:4px;">Your Holdings</h3>
                            <div id="lastUpdated" style="font-size:11px; color:#94a3b8;">
                                ðŸŸ¢ Live prices â€¢ Last updated: Loading...
                            </div>
                        </div>
                        <button onclick="refreshPortfolio()" class="btn-secondary" style="padding:8px 16px; font-size:13px;">
                            ðŸ”„ Refresh Prices
                        </button>
                    </div>
                </div>
                <table class="holdings-table">
                    <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Company Name</th>
                        <th>Shares</th>
                        <th>Current Price</th>
                        <th>Cost Basis</th>
                        <th>Market Value</th>
                        <th>P/L</th>
                        <th>Action</th>
                    </tr>
                    </thead>
                    <tbody id="holdingsTableBody"></tbody>
                </table>
            </div>
            <br>
            <!-- IPO SECTION (MOVED HERE) -->
            <div class="card scroll-section" id="ipoSection">
                <div class="card-header">
                    <h3 class="card-title">ðŸš€ IPOs</h3>
                </div>
                <div class="ipo-header-section">
                    <div class="ipo-tabs">
                        <div class="ipo-tab active" onclick="loadIPOsByStatus('upcoming')">Upcoming</div>
                        <div class="ipo-tab" onclick="loadIPOsByStatus('open')">Open</div>
                        <div class="ipo-tab" onclick="loadIPOsByStatus('closed')">Closed</div>
                        <div class="ipo-tab" onclick="loadIPOsByStatus('announced')">Announced</div>
                    </div>
                    <button class="ipo-refresh-btn" onclick="refreshIPOs()">ðŸ”„ Refresh</button>
                </div>
                <div class="cache-indicator" id="cacheIndicator"></div>
                <div id="ipos" class="ipo-container">Loading...</div>
            </div>
            <br>
            <!-- MARKET SNAPSHOT -->
            <div class="dashboard-grid grid-2 scroll-section" id="marketSection">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ðŸ“ˆ Top Gainers</h3>
                    </div>
                    <div id="gainers">Loading...</div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ðŸ“‰ Top Losers</h3>
                    </div>
                    <div id="losers">Loading...</div>
                </div>
            </div>

            <!-- MARKET NEWS -->
            <div class="card scroll-section" id="newsSection">
                <div class="card-header">
                    <h3 class="card-title">ðŸ“° Market News</h3>
                </div>
                <div id="news">Loading...</div>
            </div>
        </div>
    </main>
</div>

<!-- ADD STOCK MODAL -->
<div id="addStockModal" class="modal-bg" onclick="if(event.target === this) closeAddStockModal()">
    <div class="modal">
        <h2>Add Stock</h2>

        <div class="input-group search-box">
            <label class="input-label">Search Stock</label>
            <input id="searchInput"
                   placeholder="Search symbol or company"
                   oninput="debouncedSearch()"
                   autocomplete="off">
            <div id="searchResults" class="search-results"></div>
        </div>

        <div class="input-group">
            <label class="input-label">Symbol</label>
            <input id="symbol" placeholder="Symbol" readonly>
        </div>

        <div class="input-group">
            <label class="input-label">Company Name</label>
            <input id="companyName" placeholder="Company Name" readonly>
        </div>

        <div class="input-group">
            <label class="input-label">Quantity</label>
            <input id="quantity" type="number" min="1" placeholder="Quantity"
                   oninput="updateTotalPrice()">
        </div>

        <div class="input-group">
            <label class="input-label">Total Buy Value</label>
            <input id="buyPrice" placeholder="Total Buy Value" readonly>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:24px">
            <button class="btn-secondary" onclick="closeAddStockModal()">Cancel</button>
            <button class="btn-primary" onclick="addStock()">Save</button>
        </div>
    </div>
</div>

<!-- SELL MODAL -->
<div id="sellModal" class="modal-bg" onclick="if(event.target === this) closeSellModal()">
    <div class="modal">
        <h2>Sell Stock</h2>
        <p id="sellInfo" style="margin-bottom: 16px; color: #64748b;"></p>
        <div class="input-group">
            <label class="input-label">Quantity to Sell</label>
            <input id="sellQuantity" type="number" placeholder="Quantity to sell">
        </div>
        <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:24px">
            <button class="btn-secondary" onclick="closeSellModal()">Cancel</button>
            <button class="btn-danger" onclick="confirmSell()">Sell</button>
        </div>
    </div>
</div>

<div id="toast"></div>

<!-- SCROLLSPY NAVIGATION -->
<nav class="scrollspy-nav" id="scrollspyNav">
    <a href="#holdingsSection" class="scrollspy-item active" data-section="holdingsSection">
        <span class="scrollspy-label">Holdings</span>
        <span class="scrollspy-icon">ðŸ“Š</span>
    </a>
    <a href="#ipoSection" class="scrollspy-item" data-section="ipoSection">
        <span class="scrollspy-label">IPOs</span>
        <span class="scrollspy-icon">ðŸš€</span>
    </a>
    <a href="#marketSection" class="scrollspy-item" data-section="marketSection">
        <span class="scrollspy-label">Market</span>
        <span class="scrollspy-icon">ðŸ“ˆ</span>
    </a>
    <a href="#newsSection" class="scrollspy-item" data-section="newsSection">
        <span class="scrollspy-label">News</span>
        <span class="scrollspy-icon">ðŸ“°</span>
    </a>
</nav>

<!-- AI CHAT WIDGET -->
<button class="ai-chat-toggle" onclick="toggleAIChat()" title="Chat with Galaxy AI (Ctrl+K)">
    ðŸ¤–
</button>

<div id="aiChatContainer" class="ai-chat-container">
    <div class="ai-chat-header">
        <h3>ðŸ¤– Galaxy AI <span style="font-size:11px; opacity:0.8; font-weight:normal;">powered by Grok</span></h3>
        <div style="display:flex; gap:8px;">
            <button class="close-btn" onclick="clearAIChatHistory()" title="Clear chat">ðŸ—‘ï¸</button>
            <button class="close-btn" onclick="toggleAIChat()" title="Close">Ã—</button>
        </div>
    </div>

    <div class="ai-chat-messages" id="aiChatMessages">
        <div class="ai-message assistant">
            ðŸ‘‹ Hi! I'm <strong>Galaxy AI</strong>, your intelligent portfolio assistant powered by <strong>Grok</strong>. I can help you with:
            <br><br>
            ðŸ“Š Portfolio analysis & insights<br>
            ðŸ“ˆ Stock recommendations<br>
            ðŸ’¡ Investment advice<br>
            ðŸŽ“ Financial education
            <br><br>
            How can I help you today?
        </div>
    </div>

    <div class="ai-quick-actions">
        <button class="ai-quick-btn" onclick="sendQuickMessage('Analyze my portfolio')">ðŸ“Š Analyze Portfolio</button>
        <button class="ai-quick-btn" onclick="sendQuickMessage('What stocks should I buy?')">ðŸ’° Stock Tips</button>
        <button class="ai-quick-btn" onclick="sendQuickMessage('Explain diversification')">ðŸŽ“ Learn</button>
    </div>

    <div class="ai-chat-input">
        <input type="text" id="aiChatInput" placeholder="Ask me anything..."
               onkeypress="if(event.key === 'Enter') sendAIMessage()">
        <button onclick="sendAIMessage()" id="aiSendBtn">âž¤</button>
    </div>
</div>

<script>
    const BASE_URL = "http://localhost:8080/portfolio";
    const ALPHA_KEY = "demo";
    const FINNHUB_KEY = "d61fl21r01quq5pg3t00d61fl21r01quq5pg3t0g"; // Free Finnhub API key
    const IPO_ALERTS_KEY = "768e0b79502ba98201d4a2ffb31a3f6c5eee4d26a98075b084dae585a37802a0";

    let allocationChart, performanceChart, debounceTimer, sellStockId, sellStockSymbol, sellStockBuyPrice;
    let pricePerShare = 0;

    /* ================= REALIZED & UNREALIZED P/L TRACKING ================= */
    // Store realized profits in localStorage (persists across sessions)
    function getRealizedProfits() {
        const stored = localStorage.getItem('realizedProfits');
        return stored ? JSON.parse(stored) : {};
    }

    function saveRealizedProfit(symbol, profit) {
        const profits = getRealizedProfits();
        profits[symbol] = (profits[symbol] || 0) + profit;
        localStorage.setItem('realizedProfits', JSON.stringify(profits));
    }

    function getTotalRealizedProfit() {
        const profits = getRealizedProfits();
        return Object.values(profits).reduce((sum, val) => sum + val, 0);
    }

    function calculateUnrealizedPL(stock, currentPrice) {
        // Unrealized P/L = (Current Price - Avg Buy Price) Ã— Quantity
        return (currentPrice - stock.buyPrice) * stock.quantity;
    }

    function calculateRealizedPL(stock, sellPrice, soldQuantity) {
        // Realized P/L = (Sell Price - Avg Buy Price) Ã— Quantity Sold
        return (sellPrice - stock.buyPrice) * soldQuantity;
    }

    /* NAVIGATION */
    function showSection(section) {
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        event.target.closest('.nav-item').classList.add('active');

        // For now, all sections show dashboard
        // You can implement separate sections later
        toast(`Switched to ${section}`);
    }

    function removeAllAssets() {
        if (confirm('Are you sure you want to remove all assets?')) {
            // This would call backend to delete all stocks
            toast('Feature coming soon!');
        }
    }

    /* UI */
    function toast(msg){
        const toastEl = document.getElementById('toast');
        toastEl.innerText = msg;
        toastEl.style.display = "block";
        setTimeout(()=>toastEl.style.display="none",2500);
    }

    function openAddStockModal(){
        addStockModal.classList.add('show');
        // Clear form
        searchInput.value = '';
        symbol.value = '';
        companyName.value = '';
        quantity.value = '';
        buyPrice.value = '';
        searchResults.innerHTML = '';
    }

    function closeAddStockModal(){
        addStockModal.classList.remove('show');
    }

    function closeSellModal(){
        sellModal.classList.remove('show');
    }

    // Refresh portfolio manually
    async function refreshPortfolio() {
        toast('ðŸ”„ Refreshing prices...');
        await loadPortfolio();
        toast('âœ… Prices updated!');
    }

    // Auto-refresh every 2 minutes (optional - you can disable this)
    let autoRefreshInterval;
    function startAutoRefresh() {
        // Auto-refresh portfolio every 2 minutes
        autoRefreshInterval = setInterval(() => {
            console.log('Auto-refreshing portfolio prices...');
            loadPortfolio();
        }, 120000); // 120000ms = 2 minutes
    }

    function stopAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
    }

    /* SEARCH */
    function debouncedSearch(){
        clearTimeout(debounceTimer);
        debounceTimer=setTimeout(searchStocks,700);
    }

    async function searchStocks(){
        const q=searchInput.value.trim().toUpperCase();
        if(q.length<1) {
            searchResults.innerHTML="";
            return;
        }

        try {
            // Use Finnhub symbol lookup
            const res = await fetch(
                `https://finnhub.io/api/v1/search?q=${q}&token=${FINNHUB_KEY}`
            );

            if (!res.ok) throw new Error("Search failed");

            const data = await res.json();

            searchResults.innerHTML="";

            if (data.result && data.result.length > 0) {
                data.result.slice(0, 8).forEach(m => {
                    const symbol = m.symbol;
                    const name = m.description;
                    const type = m.type || '';

                    // Filter out non-stock results (prefer common stocks)
                    if (symbol && name) {
                        searchResults.innerHTML += `
                            <div onclick="selectStock('${symbol}','${name.replace(/'/g, "\\'")}')">
                                <strong>${symbol}</strong> â€“ ${name}
                                ${type ? `<br><small style="color:#94a3b8;">${type}</small>` : ''}
                            </div>`;
                    }
                });

                if (searchResults.innerHTML === "") {
                    searchResults.innerHTML = '<div style="color:#64748b; padding:12px;">No results found</div>';
                }
            } else {
                searchResults.innerHTML = '<div style="color:#64748b; padding:12px;">No results found</div>';
            }
        } catch (err) {
            console.error('Search error:', err);
            searchResults.innerHTML = '<div style="color:#ef4444; padding:12px;">Search failed. Please try again.</div>';
        }
    }

    /* PRICE */
    async function selectStock(sym, name){
        symbol.value = sym;
        companyName.value = name;
        searchResults.innerHTML = "";
        quantity.value = 1;

        try {
            // Use Finnhub to get current price quote
            const res = await fetch(
                `https://finnhub.io/api/v1/quote?symbol=${sym}&token=${FINNHUB_KEY}`
            );

            if (!res.ok) throw new Error("Price fetch failed");

            const data = await res.json();

            // Finnhub returns: c (current price), h (high), l (low), o (open), pc (previous close)
            pricePerShare = parseFloat(data.c || data.pc || 0);

            if (pricePerShare === 0) {
                toast('âš ï¸ Unable to fetch price. Please enter manually.');
                buyPrice.removeAttribute('readonly');
                buyPrice.value = '';
                buyPrice.placeholder = 'Enter price manually';
            } else {
                updateTotalPrice();
                toast(`âœ“ ${sym} price: $${pricePerShare.toFixed(2)}`);
            }
        } catch (err) {
            console.error('Price fetch error:', err);
            toast('âš ï¸ Unable to fetch price. Please enter manually.');
            pricePerShare = 0;
            buyPrice.removeAttribute('readonly');
            buyPrice.value = '';
            buyPrice.placeholder = 'Enter price manually';
        }
    }

    function updateTotalPrice(){
        const qty = parseInt(quantity.value || 0);
        if (qty > 0 && pricePerShare > 0) {
            buyPrice.value = `$${(pricePerShare * qty).toFixed(2)}`;
            buyPrice.setAttribute('readonly', 'readonly');
        } else {
            buyPrice.value = "";
        }
    }

    /* BACKEND */
    async function addStock(){
        const sym = symbol.value.trim();
        const name = companyName.value.trim();
        const qty = parseInt(quantity.value);

        if (!sym || !name || !qty || qty <= 0) {
            toast('âš ï¸ Please fill all fields');
            return;
        }

        // Get price - either from pricePerShare or manual entry
        let totalPrice = 0;
        if (pricePerShare > 0) {
            totalPrice = pricePerShare;
        } else {
            // Manual entry - extract number from buyPrice field
            const manualPrice = parseFloat(buyPrice.value.replace(/[^0-9.]/g, ''));
            if (!manualPrice || manualPrice <= 0) {
                toast('âš ï¸ Please enter a valid price');
                return;
            }
            totalPrice = manualPrice / qty; // Get price per share from total
        }

        closeAddStockModal();

        try {
            const res = await fetch(`${BASE_URL}/stock`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    symbol: sym,
                    companyName: name,
                    quantity: qty,
                    buyPrice: totalPrice.toFixed(2)
                })
            });

            if (!res.ok) throw new Error('Failed to add stock');

            toast("âœ“ Stock added successfully ðŸš€");
            loadPortfolio();

            // Reset form
            symbol.value = '';
            companyName.value = '';
            quantity.value = '';
            buyPrice.value = '';
            pricePerShare = 0;

        } catch (err) {
            console.error('Add stock error:', err);
            toast('âš ï¸ Failed to add stock');
        }
    }

    function openSellModal(id, sym, qty) {
        sellStockId = id;
        sellStockSymbol = sym;

        // Fetch the stock's buy price from portfolio
        fetch(BASE_URL)
            .then(res => res.json())
            .then(data => {
                const stock = data.find(s => s.id === id);
                if (stock) {
                    sellStockBuyPrice = stock.buyPrice;
                }
            });

        sellInfo.innerText = `${sym} | Available: ${qty}`;
        sellModal.classList.add('show');
    }

    async function confirmSell() {
        const soldQuantity = parseInt(sellQuantity.value);

        // Fetch current price to calculate realized profit
        const currentPrice = await fetchCurrentPrice(sellStockSymbol);
        const sellPrice = currentPrice || sellStockBuyPrice; // Fallback to buy price if API fails

        // Calculate and save realized profit
        const realizedProfit = calculateRealizedPL(
            { buyPrice: sellStockBuyPrice },
            sellPrice,
            soldQuantity
        );
        saveRealizedProfit(sellStockSymbol, realizedProfit);

        closeSellModal();

        await fetch(`${BASE_URL}/stock/${sellStockId}/sell?quantity=${soldQuantity}`, {
            method: "PUT"
        });

        toast(`Stock sold ðŸ“‰ | Realized P/L: ${realizedProfit >= 0 ? '+' : ''}$${Math.abs(realizedProfit).toFixed(2)}`);
        loadPortfolio();
    }

    /* LOAD PORTFOLIO */
    // Function to fetch real-time stock price
    async function fetchCurrentPrice(symbol) {
        try {
            // Use Finnhub for real-time quote
            const res = await fetch(
                `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${FINNHUB_KEY}`
            );

            if (!res.ok) throw new Error("Failed to fetch price");

            const data = await res.json();

            // Finnhub returns: c (current price), h (high), l (low), o (open), pc (previous close)
            if (data.c && data.c > 0) {
                return data.c;
            }

            return null;
        } catch (err) {
            console.error(`Error fetching price for ${symbol}:`, err);
            return null;
        }
    }

    async function loadPortfolio(){
        try {
            const res = await fetch(BASE_URL);
            const data = await res.json();

            const tableBody = document.getElementById('holdingsTableBody');
            tableBody.innerHTML = "<tr><td colspan='8' style='text-align:center;color:#94a3b8;'>Loading prices...</td></tr>";

            const labels = [], values = [];
            let totalValue = 0;
            let totalCost = 0;
            let totalUnrealizedPL = 0; // Track unrealized P/L

            if (data && data.length > 0) {
                // Fetch real-time prices for all stocks
                const pricePromises = data.map(stock => fetchCurrentPrice(stock.symbol));
                const currentPrices = await Promise.all(pricePromises);

                // Clear loading message
                tableBody.innerHTML = "";

                for (let i = 0; i < data.length; i++) {
                    const stock = data[i];

                    // Use fetched current price, fallback to buy price if API fails
                    const currentPrice = currentPrices[i] || stock.buyPrice;
                    const costBasis = stock.buyPrice * stock.quantity;
                    const marketValue = currentPrice * stock.quantity;
                    const pl = marketValue - costBasis;
                    const plPercent = ((pl / costBasis) * 100).toFixed(2);

                    totalValue += marketValue;
                    totalCost += costBasis;

                    // Calculate unrealized P/L for this stock
                    const unrealizedPL = calculateUnrealizedPL(stock, currentPrice);
                    totalUnrealizedPL += unrealizedPL;

                    labels.push(stock.symbol);
                    values.push(marketValue);

                    // Add indicator if price is real-time or cached
                    const priceIndicator = currentPrices[i] ? 'ðŸŸ¢' : 'ðŸŸ¡';
                    const priceTitle = currentPrices[i] ? 'Real-time price' : 'Using buy price (API unavailable)';

                    tableBody.innerHTML += `
                        <tr>
                            <td><strong>${stock.symbol}</strong></td>
                            <td>${stock.companyName || stock.name || '-'}</td>
                            <td>${stock.quantity}</td>
                            <td title="${priceTitle}">
                                <span style="font-size:10px; margin-right:4px;">${priceIndicator}</span>
                                $${currentPrice.toFixed(2)}
                            </td>
                            <td>$${costBasis.toFixed(2)}</td>
                            <td>$${marketValue.toFixed(2)}</td>
                            <td class="${pl >= 0 ? 'profit-positive' : 'profit-negative'}">
                                ${pl >= 0 ? '+' : ''}$${Math.abs(pl).toFixed(2)} (${pl >= 0 ? '+' : ''}${plPercent}%)
                            </td>
                            <td>
                                <button class="btn-danger" style="padding:6px 12px;font-size:12px"
                                    onclick="openSellModal(${stock.id},'${stock.symbol}',${stock.quantity})">
                                    Sell
                                </button>
                            </td>
                        </tr>`;
                }

                // Update header stats
                const totalReturn = totalValue - totalCost;
                const totalReturnPercent = ((totalReturn / totalCost) * 100).toFixed(1);

                document.getElementById('totalValue').textContent = `$${totalValue.toFixed(2)}`;
                document.getElementById('totalValue').className = `stat-value ${totalReturn >= 0 ? 'positive' : 'negative'}`;

                document.getElementById('totalReturn').textContent = `${totalReturn >= 0 ? '+' : ''}${totalReturnPercent}%`;
                document.getElementById('totalReturn').className = `stat-value ${totalReturn >= 0 ? 'positive' : 'negative'}`;

                // âœ… Update Unrealized P/L (calculated from current holdings with live prices)
                document.getElementById('unrealizedPL').textContent = `${totalUnrealizedPL >= 0 ? '+' : ''}$${Math.abs(totalUnrealizedPL).toFixed(2)}`;
                document.getElementById('unrealizedPL').className = `stat-value ${totalUnrealizedPL >= 0 ? 'positive' : 'negative'}`;

                // âœ… Update Realized P/L (retrieved from localStorage)
                const totalRealizedPL = getTotalRealizedProfit();
                document.getElementById('realizedPL').textContent = `${totalRealizedPL >= 0 ? '+' : ''}$${Math.abs(totalRealizedPL).toFixed(2)}`;
                document.getElementById('realizedPL').className = `stat-value ${totalRealizedPL >= 0 ? 'positive' : 'negative'}`;

                // Update last updated timestamp
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('lastUpdated').innerHTML = `ðŸŸ¢ Live prices â€¢ Last updated: ${timeStr}`;

            } else {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#94a3b8;">No holdings yet. Add your first stock!</td></tr>';
                document.getElementById('lastUpdated').innerHTML = 'âšª No holdings';

                // Reset unrealized P/L to $0.00 when no holdings
                document.getElementById('unrealizedPL').textContent = '$0.00';
                document.getElementById('unrealizedPL').className = 'stat-value';

                // Keep realized P/L even when no holdings (it persists)
                const totalRealizedPL = getTotalRealizedProfit();
                document.getElementById('realizedPL').textContent = `${totalRealizedPL >= 0 ? '+' : ''}$${Math.abs(totalRealizedPL).toFixed(2)}`;
                document.getElementById('realizedPL').className = `stat-value ${totalRealizedPL >= 0 ? 'positive' : 'negative'}`;
            }

            // Update allocation chart
            if (allocationChart) allocationChart.destroy();

            const ctx1 = document.getElementById('allocationChart').getContext('2d');
            allocationChart = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: labels.length > 0 ? labels : ['No Data'],
                    datasets: [{
                        data: values.length > 0 ? values : [1],
                        backgroundColor: [
                            '#2563eb',
                            '#10b981',
                            '#ef4444',
                            '#f59e0b',
                            '#8b5cf6',
                            '#ec4899',
                            '#06b6d4',
                            '#84cc16'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Create legend
            const legendContainer = document.getElementById('allocationLegend');
            legendContainer.innerHTML = labels.map((label, i) => `
                <div class="legend-item">
                    <div class="legend-color" style="background:${allocationChart.data.datasets[0].backgroundColor[i]}"></div>
                    <span>${label}</span>
                </div>
            `).join('');

            // Update performance chart (mock data for now)
            if (performanceChart) performanceChart.destroy();

            const ctx2 = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: ['Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Max'],
                    datasets: [{
                        label: 'Portfolio Value',
                        data: [120000, 125000, 122000, 128000, 132000, 135000, 140000, 145000, 143000, 148000, 150000, totalValue || 152430],
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value/1000) + 'k';
                                }
                            }
                        }
                    }
                }
            });

        } catch (err) {
            console.error('Portfolio load error:', err);
            toast('Failed to load portfolio');
        }
    }

    /* ================= MARKET DATA ================= */
    function renderMarketItem(item, type) {
        const isGainer = type === 'gainer';
        const isLoser = type === 'loser';
        const changeClass = isGainer ? 'profit-positive' : (isLoser ? 'profit-negative' : '');

        return `
            <div class="market-item">
                <div class="market-ticker">${item.ticker}</div>
                <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; margin-top:8px;">
                    <div>
                        <div style="font-size:11px; color:#64748b; text-transform:uppercase; margin-bottom:2px;">Price</div>
                        <div style="font-weight:600; color:#1e293b;">$${parseFloat(item.price).toFixed(2)}</div>
                    </div>
                    <div>
                        <div style="font-size:11px; color:#64748b; text-transform:uppercase; margin-bottom:2px;">Change</div>
                        <div class="${changeClass}" style="font-weight:600;">
                            ${item.change_amount > 0 ? '+' : ''}${parseFloat(item.change_amount).toFixed(2)}
                        </div>
                    </div>
                    <div>
                        <div style="font-size:11px; color:#64748b; text-transform:uppercase; margin-bottom:2px;">Change %</div>
                        <div class="${changeClass}" style="font-weight:600;">
                            ${item.change_percentage}
                        </div>
                    </div>
                    <div>
                        <div style="font-size:11px; color:#64748b; text-transform:uppercase; margin-bottom:2px;">Volume</div>
                        <div style="font-weight:600; color:#1e293b;">${formatVolume(item.volume)}</div>
                    </div>
                </div>
            </div>
        `;
    }

    function formatVolume(volume) {
        const num = parseInt(volume);
        if (num >= 1000000000) {
            return (num / 1000000000).toFixed(2) + 'B';
        } else if (num >= 1000000) {
            return (num / 1000000).toFixed(2) + 'M';
        } else if (num >= 1000) {
            return (num / 1000).toFixed(2) + 'K';
        }
        return num.toLocaleString();
    }

    async function loadMarket(){
        try {
            // Fetch with response validation
            const fetchAndParse = async (endpoint) => {
                try {
                    const response = await fetch(`${BASE_URL}${endpoint}`);
                    if (!response.ok) {
                        console.warn(`${endpoint} returned status ${response.status}`);
                        return [];
                    }
                    const text = await response.text();
                    if (!text || text.trim() === '') {
                        console.warn(`${endpoint} returned empty response`);
                        return [];
                    }
                    return JSON.parse(text);
                } catch (err) {
                    console.warn(`Failed to fetch ${endpoint}:`, err.message);
                    return [];
                }
            };

            const g = await fetchAndParse('/stock/gainers');
            const l = await fetchAndParse('/stock/losers');

            const gainersEl = document.getElementById('gainers');
            const losersEl = document.getElementById('losers');

            gainersEl.innerHTML = (g && g.length)
                ? g.slice(0,5).map(x => renderMarketItem(x, 'gainer')).join('')
                : '<div style="color:#64748b; text-align:center; padding:20px;">No strong gainers today</div>';

            losersEl.innerHTML = (l && l.length)
                ? l.slice(0,5).map(x => renderMarketItem(x, 'loser')).join('')
                : '<div style="color:#64748b; text-align:center; padding:20px;">No strong losers today</div>';
        } catch (err) {
            console.error("Market data error:", err);
            const gainersEl = document.getElementById('gainers');
            const losersEl = document.getElementById('losers');
            gainersEl.innerHTML = losersEl.innerHTML = '<div style="color:#ef4444; text-align:center; padding:20px;">Unable to load data</div>';
        }
    }

    /* ================= IPO ALERTS WITH CACHE ================= */
    let currentIPOStatus = 'upcoming';
    const IPO_CACHE_TTL = 60 * 60 * 1000; // 1 hour in milliseconds

    // Cache helper functions
    function getIPOCache(status) {
        try {
            const cacheKey = `ipo_${status}`;
            const cached = localStorage.getItem(cacheKey);
            if (!cached) return null;

            const { data, timestamp } = JSON.parse(cached);
            const now = Date.now();

            // Check if cache is still valid
            if (now - timestamp < IPO_CACHE_TTL) {
                console.log(`Using cached IPO data for status: ${status}`);
                return data;
            } else {
                // Cache expired, remove it
                localStorage.removeItem(cacheKey);
                return null;
            }
        } catch (err) {
            console.error('Cache read error:', err);
            return null;
        }
    }

    function setIPOCache(status, data) {
        try {
            const cacheKey = `ipo_${status}`;
            const cacheData = {
                data: data,
                timestamp: Date.now()
            };
            localStorage.setItem(cacheKey, JSON.stringify(cacheData));
            console.log(`Cached IPO data for status: ${status}`);
        } catch (err) {
            console.error('Cache write error:', err);
        }
    }

    function renderIPOCards(data, status, fromCache = false) {
        if (data.ipos && data.ipos.length) {
            ipos.innerHTML = data.ipos.map(ipo => `
                <div class="ipo-card">
                    <div class="ipo-header">
                        <img src="${ipo.logo || ''}" alt="${ipo.name}" class="ipo-logo"
                             onerror="this.style.display='none'">
                        <div class="ipo-name">
                            <h4>${ipo.name}</h4>
                            <span>${ipo.symbol} â€¢ ${ipo.type || 'IPO'}</span>
                        </div>
                    </div>

                    <div class="ipo-details">
                        <div class="ipo-detail">
                            <div class="ipo-detail-label">Issue Size</div>
                            <div class="ipo-detail-value">${ipo.issueSize || 'N/A'}</div>
                        </div>
                        <div class="ipo-detail">
                            <div class="ipo-detail-label">Price Range</div>
                            <div class="ipo-detail-value">â‚¹${ipo.priceRange || 'N/A'}</div>
                        </div>
                        <div class="ipo-detail">
                            <div class="ipo-detail-label">Min Amount</div>
                            <div class="ipo-detail-value">â‚¹${ipo.minAmount?.toLocaleString('en-IN') || 'N/A'}</div>
                        </div>
                        <div class="ipo-detail">
                            <div class="ipo-detail-label">Issue Date</div>
                            <div class="ipo-detail-value">${formatDate(ipo.startDate)} - ${formatDate(ipo.endDate)}</div>
                        </div>
                        <div class="ipo-detail">
                            <div class="ipo-detail-label">Listing Date</div>
                            <div class="ipo-detail-value">${formatDate(ipo.listingDate)}</div>
                        </div>
                    </div>

                    ${ipo.about ? `
                        <div class="ipo-about">
                            <strong>About:</strong> ${truncateText(ipo.about, 300)}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        } else {
            ipos.innerHTML = `No ${status} IPOs found`;
        }

        // Update cache indicator
        const cacheIndicator = document.getElementById('cacheIndicator');
        if (fromCache) {
            cacheIndicator.innerHTML = 'ðŸ“¦ Loaded from cache (updates every hour)';
        } else {
            cacheIndicator.innerHTML = 'âœ¨ Fresh data loaded';
        }
    }

    async function loadIPOsByStatus(status, forceRefresh = false, eventTarget = null) {
        currentIPOStatus = status;

        // Update active tab
        document.querySelectorAll('.ipo-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        if (eventTarget) {
            eventTarget.classList.add('active');
        } else {
            // Fallback: activate tab based on status if no event target
            const tabToActivate = document.querySelector(`.ipo-tab[onclick*="${status}"]`);
            if (tabToActivate) tabToActivate.classList.add('active');
        }

        // Check cache first (unless force refresh)
        if (!forceRefresh) {
            const cachedData = getIPOCache(status);
            if (cachedData) {
                renderIPOCards(cachedData, status, true);
                return;
            }
        }

        // Show loading if no cache or force refresh
        ipos.innerHTML = 'Loading...';
        const cacheIndicator = document.getElementById('cacheIndicator');
        cacheIndicator.innerHTML = '';

        try {
            const res = await fetch(`${BASE_URL}/stock/ipos?status=${status}`);
            const data = await res.json();

            // Save to cache
            setIPOCache(status, data);

            // Render the data
            renderIPOCards(data, status, false);
        } catch (err) {
            console.error("IPO load error:", err);
            ipos.innerHTML = "Unable to load IPO data";
            cacheIndicator.innerHTML = '';
        }
    }

    // Refresh function to force reload
    async function refreshIPOs() {
        const activeTab = document.querySelector('.ipo-tab.active');
        if (activeTab) {
            // Clear cache for current status
            const cacheKey = `ipo_${currentIPOStatus}`;
            localStorage.removeItem(cacheKey);

            // Reload with force refresh
            await loadIPOsByStatus(currentIPOStatus, true);
            toast('IPO data refreshed!');
        }
    }

    // Initial load with 'upcoming' status
    async function loadIPOs(){
        await loadIPOsByStatus('upcoming');
    }

    /* Helper function to format dates */
    function formatDate(dateStr) {
        if (!dateStr) return 'N/A';
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    /* Helper function to truncate text */
    function truncateText(text, maxLength) {
        if (!text) return '';
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }

    /* ================= NEWS ================= */
    async function loadNews() {
        try {
            const res = await fetch(
                `https://finnhub.io/api/v1/news?category=general&token=${FINNHUB_KEY}`
            );

            if (!res.ok) throw new Error("News API failed");

            const newsData = await res.json();
            const newsEl = document.getElementById('news');

            console.log('Finnhub News data:', newsData);

            // Finnhub returns array directly, not nested in 'feed'
            if (Array.isArray(newsData) && newsData.length > 0) {
                newsEl.innerHTML = newsData.slice(0, 5)
                    .map(n => {
                        const date = new Date(n.datetime * 1000); // Finnhub uses Unix timestamp
                        const timeAgo = getTimeAgo(date);

                        return `
                        <div class="market-item">
                            <a href="${n.url}" target="_blank" style="text-decoration:none; color:inherit;">
                                <div style="display:flex; gap:12px; align-items:start;">
                                    ${n.image ? `<img src="${n.image}" alt="" style="width:60px; height:60px; object-fit:cover; border-radius:8px; flex-shrink:0;">` : ''}
                                    <div style="flex:1; min-width:0;">
                                        <strong style="color:#1e293b; display:block; margin-bottom:4px; line-height:1.4; font-size:14px;">
                                            ${n.headline || 'No headline'}
                                        </strong>
                                        <small style="color:#64748b; display:block; margin-bottom:4px; font-size:12px;">
                                            ${n.source || 'Unknown'} â€¢ ${timeAgo}
                                        </small>
                                        ${n.summary ? `<p style="color:#64748b; font-size:12px; margin:0; line-height:1.4;">${truncateText(n.summary, 120)}</p>` : ''}
                                    </div>
                                </div>
                            </a>
                        </div>`;
                    })
                    .join("");
            } else {
                newsEl.innerHTML = '<div style="color:#64748b; text-align:center; padding:20px;">No market news available</div>';
            }

        } catch (err) {
            console.error("News load error:", err);
            document.getElementById('news').innerHTML = '<div style="color:#ef4444; text-align:center; padding:20px;">Unable to load market news</div>';
        }
    }

    /* Helper function to format time ago */
    function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);

        let interval = Math.floor(seconds / 31536000);
        if (interval > 1) return interval + " years ago";
        if (interval === 1) return "1 year ago";

        interval = Math.floor(seconds / 2592000);
        if (interval > 1) return interval + " months ago";
        if (interval === 1) return "1 month ago";

        interval = Math.floor(seconds / 86400);
        if (interval > 1) return interval + " days ago";
        if (interval === 1) return "1 day ago";

        interval = Math.floor(seconds / 3600);
        if (interval > 1) return interval + " hours ago";
        if (interval === 1) return "1 hour ago";

        interval = Math.floor(seconds / 60);
        if (interval > 1) return interval + " minutes ago";
        if (interval === 1) return "1 minute ago";

        return "just now";
    }

    /* ================= AI CHAT (Powered by Puter.js + Grok) ================= */
    let isAIChatOpen = false;
    let conversationHistory = [];

    // System prompt for Galaxy AI
    const GALAXY_AI_SYSTEM_PROMPT = `You are Galaxy AI, an intelligent financial advisor assistant integrated into a portfolio management application called Galaxy.

Your role is to:
1. Provide helpful, accurate financial advice and insights
2. Analyze portfolio data when provided
3. Explain investment concepts in simple terms
4. Help users understand market trends and stock performance
5. Suggest portfolio optimization strategies
6. Answer questions about stocks, ETFs, mutual funds, and other investments

Guidelines:
- Be concise but informative
- Use bullet points for clarity when listing multiple items
- Include relevant emojis to make responses engaging (ðŸ“ˆ ðŸ“‰ ðŸ’° ðŸŽ¯ âš ï¸ ðŸ’¡)
- Always remind users that this is not personalized financial advice and they should consult a professional
- If you don't know something, say so honestly
- When analyzing portfolios, consider diversification, risk, and potential returns

Format your responses in a clear, readable way.`;

    function toggleAIChat() {
        const container = document.getElementById('aiChatContainer');
        isAIChatOpen = !isAIChatOpen;

        if (isAIChatOpen) {
            container.classList.add('show');
            document.getElementById('aiChatInput').focus();
        } else {
            container.classList.remove('show');
        }
    }

    function addMessageToChat(message, role) {
        const messagesContainer = document.getElementById('aiChatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `ai-message ${role}`;

        // Format the message (convert markdown-like formatting)
        let formattedMessage = message
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\n/g, '<br>')
            .replace(/```([\s\S]*?)```/g, '<pre>$1</pre>');

        messageDiv.innerHTML = formattedMessage;
        messagesContainer.appendChild(messageDiv);

        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function showTypingIndicator() {
        const messagesContainer = document.getElementById('aiChatMessages');
        const typingDiv = document.createElement('div');
        typingDiv.className = 'ai-message assistant typing';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = '<span></span><span></span><span></span>';
        messagesContainer.appendChild(typingDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function removeTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }

    // Build portfolio context for AI
    async function buildPortfolioContext() {
        try {
            const res = await fetch(BASE_URL);
            const stocks = await res.json();

            if (!stocks || stocks.length === 0) {
                return "User has no stocks in their portfolio yet.";
            }

            let context = "Current Portfolio Holdings:\n";
            let totalInvested = 0;

            for (const stock of stocks) {
                const invested = stock.totalInvestedAmount || (stock.buyPrice * stock.quantity);
                totalInvested += invested;
                context += `- ${stock.symbol} (${stock.companyName || 'N/A'}): ${stock.quantity} shares @ $${stock.buyPrice.toFixed(2)} avg cost (Total: $${invested.toFixed(2)})\n`;
            }

            context += `\nTotal Portfolio Investment: $${totalInvested.toFixed(2)}`;
            context += `\nNumber of Holdings: ${stocks.length}`;

            return context;
        } catch (error) {
            console.error('Error building portfolio context:', error);
            return "Unable to fetch portfolio data.";
        }
    }

    async function sendAIMessage() {
        const input = document.getElementById('aiChatInput');
        const sendBtn = document.getElementById('aiSendBtn');
        const message = input.value.trim();

        if (!message) return;

        // Add user message to chat
        addMessageToChat(message, 'user');
        input.value = '';

        // Disable input while processing
        input.disabled = true;
        sendBtn.disabled = true;

        // Show typing indicator
        showTypingIndicator();

        try {
            // Build portfolio context
            const portfolioContext = await buildPortfolioContext();

            // Build the full prompt with context
            const fullPrompt = `${GALAXY_AI_SYSTEM_PROMPT}

Current Portfolio Context:
${portfolioContext}

User Question: ${message}`;

            // Call Grok via Puter.js - using exact model name from docs
            const response = await puter.ai.chat(fullPrompt, {
                model: 'x-ai/grok-4.1-fast'
            });

            removeTypingIndicator();

            if (response && response.message && response.message.content) {
                addMessageToChat(response.message.content, 'assistant');
            } else if (response && typeof response === 'string') {
                addMessageToChat(response, 'assistant');
            } else {
                addMessageToChat('I received a response but couldn\'t parse it. Please try again.', 'assistant');
                console.log('Unexpected response format:', response);
            }

        } catch (error) {
            removeTypingIndicator();
            console.error('AI Chat error:', error);

            // Provide helpful error message
            let errorMsg = 'âŒ Sorry, I encountered an error. ';
            if (error && error.message) {
                errorMsg += error.message;
            } else if (error && typeof error === 'string') {
                errorMsg += error;
            } else {
                errorMsg += 'Please try again in a moment.';
            }
            addMessageToChat(errorMsg, 'assistant');
        }

        // Re-enable input
        input.disabled = false;
        sendBtn.disabled = false;
        input.focus();
    }

    function sendQuickMessage(message) {
        document.getElementById('aiChatInput').value = message;
        sendAIMessage();
    }

    // Clear conversation history
    function clearAIChatHistory() {
        const messagesContainer = document.getElementById('aiChatMessages');
        messagesContainer.innerHTML = `
            <div class="ai-message assistant">
                ðŸ‘‹ Hi! I'm <strong>Galaxy AI</strong>, your intelligent portfolio assistant powered by <strong>Grok</strong>. I can help you with:
                <br><br>
                ðŸ“Š Portfolio analysis & insights<br>
                ðŸ“ˆ Stock recommendations<br>
                ðŸ’¡ Investment advice<br>
                ðŸŽ“ Financial education
                <br><br>
                How can I help you today?
            </div>
        `;
    }

    // Keyboard shortcut to open AI chat (Ctrl/Cmd + K)
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            toggleAIChat();
        }
        // Close chat with Escape
        if (e.key === 'Escape' && isAIChatOpen) {
            toggleAIChat();
        }
    });

    /* ================= SCROLLSPY NAVIGATION ================= */
    function initScrollspy() {
        const sections = document.querySelectorAll('.scroll-section');
        const navItems = document.querySelectorAll('.header-nav-item');

        if (sections.length === 0 || navItems.length === 0) return;

        // Smooth scroll on click
        navItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('href').substring(1);
                const targetSection = document.getElementById(targetId);

                if (targetSection) {
                    targetSection.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                    updateActiveNav(targetId);
                }
            });
        });

        // Update active state on scroll
        let scrollTimeout;
        window.addEventListener('scroll', function() {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(updateScrollspy, 50);
        });

        updateScrollspy();
    }

    function updateActiveNav(activeId) {
        document.querySelectorAll('.header-nav-item').forEach(item => {
            const sectionId = item.getAttribute('data-section');
            if (sectionId === activeId) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
    }

    function updateScrollspy() {
        const sections = document.querySelectorAll('.scroll-section');
        if (sections.length === 0) return;

        const scrollPosition = window.scrollY + 150;
        let currentSection = null;

        sections.forEach(section => {
            const sectionTop = section.offsetTop;
            const sectionHeight = section.offsetHeight;

            if (scrollPosition >= sectionTop && scrollPosition < sectionTop + sectionHeight) {
                currentSection = section.id;
            }
        });

        if (!currentSection && sections.length > 0) {
            if (scrollPosition < sections[0].offsetTop) {
                currentSection = sections[0].id;
            } else {
                currentSection = sections[sections.length - 1].id;
            }
        }

        if (currentSection) {
            updateActiveNav(currentSection);
        }
    }

    /* ================= INIT ================= */
    loadMarket();
    loadIPOs();
    loadNews();
    loadPortfolio();

    // Initialize scrollspy
    setTimeout(initScrollspy, 100);

    // Start auto-refresh for live prices (updates every 2 minutes)
    // Comment out the line below if you don't want auto-refresh
    startAutoRefresh();
</script>

</body>
</html>

